<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>{$title}</title>
		<link href="../../css/bootstrap.min.css" rel="stylesheet">
		<link href="../../font-awesome/css/font-awesome.css" rel="stylesheet">
		<link href="../../css/animate.css" rel="stylesheet">
		<!-- Toastr style -->
		<link href="../../css/plugins/toastr/toastr.min.css" rel="stylesheet">

		<!--Темы редактора-->
		<link href="../../css/plugins/codemirror/codemirror.css" 	rel="stylesheet">
		<link href="../../css/plugins/codemirror/ambiance.css" 		rel="stylesheet">
		<link href="../../css/plugins/codemirror/elegant.css" 		rel="stylesheet">
		<link href="../../css/plugins/codemirror/neo.css" 			rel="stylesheet">
		<link href="../../css/plugins/codemirror/material.css" 		rel="stylesheet">
		<link href="../../css/plugins/codemirror/neat.css" 			rel="stylesheet">
		<link href="../../css/plugins/codemirror/base16-light.css" 	rel="stylesheet">
		<link href="../../css/plugins/codemirror/zenburn.css" 		rel="stylesheet">
		<link href="../../css/plugins/codemirror/php.css" 			rel="stylesheet">
		<link href="../../css/plugins/codemirror/elegant.css" 		rel="stylesheet">
		<link href="../../css/plugins/codemirror/mdn-like.css"		rel="stylesheet">
		<link href="../../css/style.css" rel="stylesheet">
		<!--Дерево-->
		<link href="../../css/plugins/jsTree/style.min.css" rel="stylesheet">
		<style>
			.jstree-open > .jstree-anchor > .fa-folder:before {
			content: "\f07c";
			}
			.jstree-default .jstree-icon.none {
			width: 0;
			}
		</style>
		<base href="{$$base}" id='baseurl' data-info='../../'>
	</head>
	<body>
		<div id="wrapper">

		<!--Главное меню слева-->
		{require "../../~section/mainmenu.html"}
		<!--Конец меню-->

		<div id="page-wrapper" class="gray-bg">

			<!-- Head menu -->
			{require "../../~section/head.html"}
			<!-- End head menu -->


			<!-- Менюшка title-->
			{require "../../~section/title.html"}
			<!-- конец title-->

			<div class="wrapper wrapper-content  animated fadeInRight">
				<div class="row">
					{if ($config === null ) and ($code === null)}
						<div class="col-lg-6">
							<div class="ibox float-e-margins">
								<div class="ibox-title">
									<h5>Дерево файлов <small> используйте его для открытия файла, который требуется редактировать</small></h5>
									<div class="ibox-tools">
										<a class="collapse-link">
										<i class="fa fa-chevron-up"></i>
										</a>
										<a class="close-link">
										<i class="fa fa-times"></i>
										</a>
									</div>
								</div>
								<div class="ibox-content">
									<literal>
										<table>
											<div id="jstree1">
												<ul>
													<li class="jstree-open list-unstyled " id='view-tree'>
														<div class="list-unstyled text-center col-lg-12 col-md-12">
															<i class="fa fa-history mid-icon text-navy text-center "></i>
														</div>
														<!--
															<ul>
																<li>css
																	<ul>
																		<li  data-jstree='{"type":"css"}'>animate.css</li>
																		<li  data-jstree='{"type":"css"}'>bootstrap.css</li>
																		<li  data-jstree='{"type":"css"}'>style.css</li>
																	</ul>
																</li>
																<li>email-templates
																	<ul>
																		<li  data-jstree='{"type":"html"}'>action.html</li>
																		<li  data-jstree='{"type":"html"}'>alert.html</li>
																		<li  data-jstree='{"type":"html"}'>billing.html</li>
																	</ul>
																</li>
																<li>fonts
																	<ul>
																		<li data-jstree='{"type":"svg"}'>glyphicons-halflings-regular.eot</li>
																		<li data-jstree='{"type":"svg"}'>glyphicons-halflings-regular.svg</li>
																		<li data-jstree='{"type":"svg"}'>glyphicons-halflings-regular.ttf</li>
																		<li data-jstree='{"type":"svg"}'>glyphicons-halflings-regular.woff</li>
																	</ul>
																</li>
																<li>img
																	<ul>
																		<li data-jstree='{"type":"img"}'>profile_small.jpg</li>
																		<li data-jstree='{"type":"img"}'>angular_logo.png</li>
																		<li class="text-navy" data-jstree='{"type":"img"}'>html_logo.png</li>
																		<li class="text-navy" data-jstree='{"type":"img"}'>mvc_logo.png</li>
																	</ul>
																</li>
																<li class="jstree-open">js
																	<ul>
																		<li data-jstree='{"type":"js"}'>inspinia.js</li>
																		<li data-jstree='{"type":"js"}'>bootstrap.js</li>
																		<li data-jstree='{"type":"js"}'>jquery-2.1.1.js</li>
																		<li data-jstree='{"type":"js"}'>jquery-ui.custom.min.js</li>
																		<li class="text-navy" data-jstree='{"type":"js"}'>jquery-ui-1.10.4.min.js</li>
																	</ul>
																</li>
																<li data-jstree='{"type":"html"}'> affix.html</li>
																<li data-jstree='{"type":"html"}'> dashboard.html</li>
																<li data-jstree='{"type":"html"}'> buttons.html</li>
																<li data-jstree='{"type":"html"}'> calendar.html</li>
																<li data-jstree='{"type":"html"}'> contacts.html</li>
																<li data-jstree='{"type":"html"}'> css_animation.html</li>
																<li  class="text-navy" data-jstree='{"type":"html"}'> flot_chart.html</li>
																<li  class="text-navy" data-jstree='{"type":"html"}'> google_maps.html</li>
																<li data-jstree='{"type":"html"}'> icons.html</li>
																<li data-jstree='{"type":"html"}'> inboice.html</li>
																<li data-jstree='{"type":"html"}'> login.html</li>
																<li data-jstree='{"type":"html"}'> mailbox.html</li>
																<li data-jstree='{"type":"html"}'> profile.html</li>
																<li  class="text-navy" data-jstree='{"type":"html"}'> register.html</li>
																<li data-jstree='{"type":"html"}'> timeline.html</li>
																<li data-jstree='{"type":"html"}'> video.html</li>
																<li data-jstree='{"type":"html"}'> widgets.html</li>
															</ul>
															-->
													</li>
												</ul>
											</div>
										</table>
									</literal>
								</div>
							</div>
						</div>
						<div class="col-lg-6">
							<div class="ibox float-e-margins">
								<div class="ibox-title">
									<h5>Информация</h5>
									<div class="ibox-tools">
										<a class="collapse-link">
										<i class="fa fa-chevron-up"></i>
										</a>
										<a class="close-link">
										<i class="fa fa-times"></i>
										</a>
									</div>
								</div>
								<div class="ibox-content " id='ibox-content' >
									<div class="wrapper wrapper-content project-manager">
										<div class="text-center">
											<i class="fa fa-th-list mid-icon " style="opacity:0.3" > </i>
										</div>
										<!--
											<h4>Project description</h4>
											<img src="img/zender_logo.png" class="img-responsive">
											<i class="fa fa-folder forum-icon mid-icon text-navy " > </i>

											<p class="small">
												There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look
												even slightly believable. If you are going to use a passage of Lorem Ipsum, you need to be sure there isn't anything embarrassing
											</p>
											<p class="small font-bold">
												<span><i class="fa fa-circle text-warning"></i> High priority</span>
											</p>
											<h5>Project tag</h5>
											<ul class="tag-list" style="padding: 0">
												<li><a href=""><i class="fa fa-tag"></i> Zender</a></li>
												<li><a href=""><i class="fa fa-tag"></i> Lorem ipsum</a></li>
												<li><a href=""><i class="fa fa-tag"></i> Passages</a></li>
												<li><a href=""><i class="fa fa-tag"></i> Variations</a></li>
											</ul>

											<h5 class="col-lg-12">Информация об объекте</h5>
											<ul class="list-unstyled project-files">
												<li>	<i class="fa fa-file"></i> Дата создания:				</li>
												<li>	<i class="fa fa-file"></i> Дата доступа:				</li>
												<li>	<i class="fa fa-file-picture-o"></i> Размер:	</li>
												<li>	<i class="fa fa-stack-exchange"></i> Права:		</li>
												<li>	<i class="fa fa-file"></i> Владелец:			</li>
											</ul>
											<div class="text-center m-t-md">
												<a href="#" class="btn btn-xs btn-primary">Add files</a>
												<a href="#" class="btn btn-xs btn-primary">Редактировать</a>

											</div>
											</div>


											<div id="infotext">
											jsTree is jquery plugin, that provides interactive trees. It is absolutely free, open source and distributed under the MIT license. jsTree is easily extendable, themable and configurable, it supports HTML & JSON data sources and AJAX loading. Get more info on: http://www.jstree.com/
											</div>
											-->
									</div>
								</div>
							</div>
						</div>
						{end}
						{if $config !== null}
						<form class="col-lg-12" id='config_editor_form'>
							<div class="ibox ">
								<div class="ibox-title">
									<h5>
										Конфигурация
										<small>для изменения файла нажмите кнопку "Сохранить"</small>
									</h5>
									<div class="ibox-tools">
										<!--
											<button type="button" class="btn btn-primary btn-xs m-l-sm" onclick="save_textarea('config_editor_form', '{$filename['config']}')">Сохранить</button>
											-->
										<label id='result-label-config'></label>
										<button type="button" class="btn-save btn btn-primary btn-xs m-l-sm" onclick="AjaxFormRequest('result-label-config', 'config_editor_form', '{$config['action']}')">Сохранить</button>
										<a class="collapse-link">
										<i class="fa fa-chevron-up"></i>
										</a>
										<!--
											<a class="dropdown-toggle" data-toggle="dropdown" href="#">
											    <i class="fa fa-wrench"></i>
											</a>
											<ul class="dropdown-menu dropdown-user">
											    <li>
											        <a href="#">Config option 1</a>
											    </li>
											    <li>
											        <a href="#">Config option 2</a>
											    </li>
											</ul>
											-->
										<a class="close-link">
										<i class="fa fa-times"></i>
										</a>
									</div>
								</div>
								<div class="ibox-content">
									<input type="hidden" name="config[filename]" value="{$config['filename']}">
									<!--
										<p  class="m-b-lg">
										    <strong>CodeMirror</strong> is a versatile text editor implemented in JavaScript for the browser. It is specialized for editing code, and comes with a number of language modes and addons that implement more advanced editing functionality.
										</p>
										-->
									<textarea id="config_editor"  name="config[body]">{$config['body']}</textarea>
								</div>
							</div>
						</form>
						{end}
						{if $code !== null}
						<form class="col-lg-12" method="POST"  id='code_editor_form' >
							<div class="ibox ">
								<div class="ibox-title">
									<h5>
										Код
										<small>для изменения файла нажмите кнопку "Сохранить"</small>
									</h5>
									<div class="ibox-tools">
										<!--
											<button type="button" class="btn btn-primary btn-xs m-l-sm" onclick="send_textarea('code_editor', '')" >Сохранить</button>
											-->
										<label class='text-success' id='result-label-code'></label>
										<button type="button" class="btn-save btn btn-primary btn-xs m-l-sm" onclick="AjaxFormRequest('result-label-code', 'code_editor_form', '{$code['action']}')">Сохранить</button>
										<a class="collapse-link">
										<i class="fa fa-chevron-up"></i>
										</a>
										<!--
											<a class="dropdown-toggle" data-toggle="dropdown" href="#">
											    <i class="fa fa-wrench"></i>
											</a>
											<ul class="dropdown-menu dropdown-user">
											    <li>
											        <a href="#">Config option 1</a>
											    </li>
											    <li>
											        <a href="#">Config option 2</a>
											    </li>
											</ul>
											-->
										<a class="close-link">
										<i class="fa fa-times"></i>
										</a>
									</div>
								</div>
								<div class="ibox-content">
									<input type="hidden" name="code[filename]" value="{$code['filename']}">
									<!--
										<p class="m-b-lg">
										    A rich programming API and a CSS theming system are available for customizing CodeMirror to fit your application, and extending it with new functionality. For mor info go to
										    <a href="http://codemirror.net/" target="_blank">http://codemirror.net/</a>
										</p>
										-->
									<textarea id="code_editor" style="text-align: left;" name="code[body]">{$code['body']}</textarea>
								</div>
							</div>
						</form>
						{end}
					</div>
				</div>
				<!-- Footer block -->
				{require "../../~section/footer.html"}
				<!-- End Footer block -->
			</div>
		</div>
		<!-- Mainly scripts -->
		<script src="../../js/jquery-2.1.1.js"></script>
		<script src="../../js/bootstrap.min.js"></script>
		<script src="../../js/plugins/metisMenu/jquery.metisMenu.js"></script>
		<script src="../../js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
		<!-- Toastr -->
		<script src="../../js/plugins/toastr/toastr.min.js"></script>
		<!-- CodeMirror -->
		<script src="../../js/plugins/codemirror/codemirror.js"></script>
		<script src="../../js/plugins/codemirror/mode/javascript/javascript.js"></script>
		<script src="../../js/plugins/codemirror/mode/php/php.js"></script>
		<script src="../../js/plugins/codemirror/mode/properties/properties.js"></script>
		<script src="../../js/plugins/codemirror/mode/meta.js"></script>
		<!--
			<script src="../../js/plugins/codemirror/mode/shell/shell.js"></script>
			-->
		<!-- Custom and plugin javascript -->
		<script src="../../js/inspinia.js"></script>
		<script src="../../js/plugins/pace/pace.min.js"></script>



		<script>
			$(document).ready(function()
			{

				if (document.getElementById("config_editor"))
				{
					var editor_one = CodeMirror.fromTextArea(document.getElementById("config_editor"),
					{
						//~ lineNumbers: true,
						//~ matchBrackets: true,
						//~ styleActiveLine: true,
						//~ mode: "text/x-ini",
						//~ theme:"zenburn"
		                 lineNumbers: true,
						 matchBrackets: true,
						 styleActiveLine: true,
						 mode: "text/x-ini",
						 theme:"ambiance"
					});

					document.editor_one = editor_one;
				}

				if (document.getElementById("code_editor"))
				{
					var editor_two = CodeMirror.fromTextArea(document.getElementById("code_editor"),
					{
						lineNumbers: true,
						matchBrackets: true,
						styleActiveLine: true,
						mime: "application/x-httpd-php",
						mime: "text/x-ini",
						theme:"php"
					});

					document.editor_two = editor_two;
				}

			});
		</script>

		<script src="../../js/plugins/jsTree/jstree.min.js"></script>
		<script>

			//загружаем дерево из контроллера и по окончанию построить дерево
			$('#view-tree').load( "admin/tools/filemanager/file_tree", jstree_construct );


			//$(document).ready(jstree_construct);
			//функция строит дерево
			function jstree_construct()
			{


				$('#jstree1').jstree({
					'core' : {
						'check_callback' : true
					},
					'plugins' : [ 'types', 'dnd' ],
					'types' : {
						'default' : {
							'icon' : 'fa fa-folder'
						},
						'html' : {
							'icon' : 'fa fa-file-code-o'
						},
						'svg' : {
							'icon' : 'fa fa-file-picture-o'
						},
						'css' : {
							'icon' : 'fa fa-file-code-o'
						},
						'img' : {
							'icon' : 'fa fa-file-image-o'
						},
						'js' : {
							'icon' : 'fa fa-file-text-o'
						}

					}
				});

				//Одиночный клик по файлу
				$('li').click(function ()
				{
					if (this.className=='on')
					{
						//action();
					}
					else
					{
						//select(this);
					};

				});



				//Двойной клик на файле (или диретории)
				$('li').dblclick(function (event)
				{
					var dir = $(this).attr('placeholder');
					if (dir == undefined) return;

					var target = event.target.parentNode; // где был клик?
					var filename = $(target).attr('placeholder');
					location.href = 'admin/tools/codeeditor/?file='+filename;
				});

				//Одинарный клик на файле (или диретории)
				$('li').click(function (event)
				{
					var target = event.target.parentNode; // где был клик?
					var dir = $(target).attr('placeholder');


					//~ var dir = $(this).attr('placeholder');
					if (dir == undefined) return;

					$('#ibox-content').load('admin/tools/filemanager/file_info.php?path='+dir);
				});

			};



			function send_textarea(id, filename)
			{

				alert($('#code_editor').val());

				$.ajax({
					type: "POST",
					url: "admin/tools/codeeditor/save.php",  <!--путь файла обработчика  -->
					data: "text="+$("textarea#"+id).val(),  <!--textarea   -->
					success: function(html)
					{
						alert(html);
						//$("#test").html(html); <!--возвращаем ответ сервера  -->
					}
				});
			}




			function AjaxFormRequest(result_id, formMain, url)
			{

				if (document.editor_one != undefined) document.editor_one.save();
				if (document.editor_two != undefined) document.editor_two.save();


				jQuery.ajax({
				 url: url,
				 type: "POST",
				 dataType: "html",
				 data: jQuery("#"+formMain).serialize(),
				 success: function(response)
				 {
					 //~ console.log(jQuery("#"+formMain).serialize());
					document.getElementById(result_id).innerHTML = "<i class='fa fa-circle text-success'></i> " + response;

					//Удалим запись об удачном сохранении через 2 секунды
					var timerId = setTimeout(function tick()
						{
						  $('#'+result_id).html('');
						}, 2000);

					toastr.options =
					{
						closeButton: true,
						progressBar: true,
						showMethod: 'slideDown',
						timeOut: 4000
					};
					toastr.success('', response);

				 },
				 error: function(response)
				 {
					document.getElementById(result_id).innerHTML = "<i class='fa fa-circle text-alert'></i> " + "Возникла сетевая ошибка при отправке формы! Попробуйте еще раз";
					toastr.error(response, "Возникла сетевая ошибка при отправке формы! Попробуйте еще раз");
				 }
				 });
			}


			$(document).bind('keydown', function(e)
			{
			  if(e.ctrlKey && (e.which == 83))
			  {
				e.preventDefault();
				$('.btn-save').trigger('click');
				return false;
			  }
			});


		</script>

	</body>
</html>
