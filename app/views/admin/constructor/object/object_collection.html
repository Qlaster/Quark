<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>{$title}</title>
		<link href="../../css/bootstrap.min.css" rel="stylesheet">
		<link href="../../font-awesome/css/font-awesome.css" rel="stylesheet">
		<!-- Toastr style -->
	  <link href="../../css/plugins/toastr/toastr.min.css" rel="stylesheet">
		<link href="../../css/animate.css" rel="stylesheet">
		<link href="../../css/style.css" rel="stylesheet">
		<base href="{$$base}">
	</head>
	<body>
		<div id="wrapper">
			<!--Главное меню слева-->
			{require "../../~section/mainmenu.html"}
			<!--Конец меню-->

			<div id="page-wrapper" class="gray-bg">

			<!-- Head menu -->
			{require "../../~section/head.html"}
			<!-- End head menu -->

			<!-- Менюшка title-->
			{require "../../~section/title.html"}
			<!-- конец title-->

				<div class="wrapper wrapper-content">
					<div class="row">
						<div class="col-lg-4 animated fadeInDown">





							<div class="ibox float-e-margins">
								<div class="ibox-title">
									 <h5>{$catalog['collection']['head']}</h5>
									 <div class="ibox-tools">
										  <a class="collapse-link">
												<i class="fa fa-chevron-up"></i>
										  </a>
										  <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
												<i class="fa fa-wrench"></i>
										  </a>
										  <ul class="dropdown-menu dropdown-user">
												<li><a target="_blank" href="admin/constructor/object/export">Экспортировать</a>
												</li>
												<li><a onclick="importObjects()">Импортировать</a>
												</li>
										  </ul>
<!--
										  <a class="close-link">
												<i class="fa fa-times"></i>
										  </a>
-->
									 </div>
								</div>


								<div class="ibox-content">
									<div class="file-manager">
<!--
										<h5>{$catalog['collection']['head']}</h5>
-->
										<!--
											<a href="#" class="file-control active">Ale</a>
											<a href="#" class="file-control">Documents</a>
											<a href="#" class="file-control">Audio</a>
											<a href="#" class="file-control">Images</a>
											-->
<!--
										<div class="hr-line-dashed"></div>
-->
										<form id="new-collection-form" action="{$form['collection']['action']}" method='get'>
											<input name='collection' placeholder="Имя новой коллекции" class="form-control new-collection-name">
											<p></p>
											<button type="submit" class="btn btn-primary !btn-sm btn-outline btn-block new-collection-btn">{$form['collection']['button']['add']['head']}</button>
										</form>
										<div class="hr-line-dashed"></div>
										<h5>{$catalog['collection']['info']}</h5>
										<ul class="folder-list" style="padding: 0">
											{foreach $catalog['collection']['list'] as $_value}
												<li {if $_value['active']} class='text-info' {end}>
												<a href="{$_value['link']}"><i class="{$_value['icon']}"></i>{$_value['head']}</a>
<!--
												<a href="{$_value['delete_link']}">
-->
<!--
													<button type="button" class="btn btn-warning btn-xs pull-right" data-link="{$_value['button']['delete']['link']}">{$_value['button']['delete']['head']}</button>
-->
													<!-- <button type="button" class="btn btn-delete-collection btn-warning btn-xs pull-right" data-head="{$_value['head']}" data-link="{$_value['button']['delete']['link']}"><span class="fa fa-trash"></span></button> -->

													<!-- <div class="btn-group pull-right">
														<button data-toggle="dropdown" class="btn btn-success btn-xs dropdown-toggle">Действия <span class="caret"></span></button>
														<ul class="dropdown-menu">
															<li><a href="#">Переименовать</a></li>
															<li><a href="#">Дублировать</a></li>
															<li><a href="#">Удалить</a></li>
															<li class="divider"></li>
															<li><a href="#">Экспортировать</a></li>
															<li><a href="#">Импортировать</a></li>
														</ul>
													</div> -->

													{foreach ($_value['button']) as $_button}
														{if isset($_button['list'])}
															<div class="btn-group pull-right">
																<button data-toggle="dropdown" class="btn btn-success btn-xs dropdown-toggle">{$_button['head']} <span class="caret"></span></button>
																<ul class="dropdown-menu">
																{foreach $_button['list'] as $_submenu_btn}
																	<li><a {if $_submenu_btn['link']}href="{$_submenu_btn['link']}"{end} {if $_submenu_btn['data-collection']} onclick="showRenameModal(`{$_submenu_btn['data-collection']}`, `{$_submenu_btn['data-link']}`)" {end}>{$_submenu_btn['head']}</a></li>
																{end}
																</ul>
															</div>
														{else}
															<a class="btn btn-white btn-xs" href="{$_button['link']}"><i class="fa {$_button['icon']}"></i> {$_button['head']}</a>
														{end}
													{end}
<!--
												</a>
-->
											</li>
											{end}
										</ul>
										<!--
											<ul class="folder-list" style="padding: 0">
												 <li><a href=""><i class="fa fa-th-list"></i> Files</a></li>
												 <li><a href=""><i class="fa fa-database"></i> Pictures</a></li>
												 <li><a href=""><i class="fa fa-database"></i> Web pages</a></li>
												 <li><a href=""><i class="fa fa-database"></i> Illustrations</a></li>
												 <li><a href=""><i class="fa fa-database"></i> Films</a></li>
												 <li><a href=""><i class="fa fa-database"></i> Books</a></li>
											</ul>
											-->
										<!--
											<h5 class="tag-title">Tags</h5>
											<ul class="tag-list" style="padding: 0">
												 <li><a href="">Family</a></li>
												 <li><a href="">Work</a></li>
												 <li><a href="">Home</a></li>
												 <li><a href="">Children</a></li>
												 <li><a href="">Holidays</a></li>
												 <li><a href="">Music</a></li>
												 <li><a href="">Photography</a></li>
												 <li><a href="">Film</a></li>
											</ul>
											-->
										<div class="clearfix"></div>
									</div>
								</div>
							</div>


<!--
							<div class="ibox float-e-margins">
						<div class="ibox-content">
							<div class="file-manager">
								<h5>{$catalog['tools']['head']}</h5>
								<div class="hr-line-dashed"></div>
								<form action="{$form['collection']['action']}" method='get'>
									<input name='collection' placeholder="Имя новой коллекции" class="form-control">
									<p></p>
									<button type="submit" class="btn btn-primary btn-block">{$form['collection']['button']['add']['head']}</button>
								</form>
								<div class="hr-line-dashed"></div>
								<button type="submit" class="btn btn-primary !btn-block">{$form['tools']['button']['export']['head']}</button>
								<button type="submit" class="btn btn-primary !btn-block">{$form['tools']['button']['import']['head']}</button>

								<div class="clearfix"></div>
							</div>
						</div>
					</div>
-->



						</div>

						<div class="col-lg-8 animated fadeInRight"  style="z-index:1">
							<div class="row">
								<div class="col-lg-12">
									<div class="ibox float-e-margins">
										<div class="ibox-title">
											<h5>{$catalog['objects']['head']}</h5>
											<button class="btn btn-primary btn-xs pull-right edit-object" data-link="{$catalog['objects']['button']['add']['link']}" disabled>{$catalog['objects']['button']['add']['head']}</button>
											<!--
												<div class="ibox-tools">
													<a class="collapse-link">
														<i class="fa fa-chevron-up"></i>
													</a>
													<a class="dropdown-toggle" data-toggle="dropdown" href="#">
														<i class="fa fa-wrench"></i>
													</a>
													<ul class="dropdown-menu dropdown-user">
														<li><a href="#">Создать новый элемент</a>
														</li>
														<li><a href="#">Удалить коллекцию</a>
														</li>
													</ul>
													<a class="close-link">
														<i class="fa fa-times"></i>
													</a>
												</div>
												-->
										</div>
										<div class="ibox-content">
											<table class="table table-striped table-bordered table-hover dataTables-example" >
												<thead>
													<tr>
														<th>Название объекта</th>
														<th class="col-lg-5"></th>
													</tr>
												</thead>
												<tbody>
													{foreach $catalog['objects']['list'] as $_value}
													<tr class="gradeA">
														<td><a class='text-primary !btn-block' {if $_value['link']} href="{$_value['link']}" {end}>{$_value['head']}</a></td>
														<td class='center'>
															
														<!-- <div class="btn-group">
															<button data-toggle="dropdown" class="btn btn-white btn-xs dropdown-toggle">Действия <span class="caret"></span></button>
															<ul class="dropdown-menu">
																<li><a href="#">Открыть в конструкторе</a></li>
																<li><a href="#">Открыть в редакторе</a></li>
																<li><a href="#">Открыть в приложении</a></li>
																<li class="divider"></li>
																<li><a href="#">Экспортировать</a></li>
																<li><a href="#">Импортировать</a></li>
															</ul>
														</div> -->

														{foreach ($_value['button']) as $_button}
															
															{if isset($_button['list'])}
																<div class="btn-group pull-left">
																	<button data-toggle="dropdown" class="btn btn-white btn-xs dropdown-toggle">{$_button['head']} <span class="caret"></span></button>
																	<ul class="dropdown-menu">
																	{foreach $_button['list'] as $_submenu_btn}
																		<li><a {if $_submenu_btn['link']} href="{$_submenu_btn['link']}" {end} {if $_submenu_btn['data-collection']} onclick="showRenameModal(`{$_submenu_btn['data-collection']}`, `{$_submenu_btn['data-link']}`, `{$_submenu_btn['data-object']}`)" {end}>{$_submenu_btn['head']}</a></li>
																	{end}
																	</ul>
																</div>
															{else}
																<a class="btn btn-white btn-xs" href="{$_button['link']}"><i class="fa {$_button['icon']}"></i> {$_button['head']}</a>
															{end}
															
														{end}
<!--
											<a class="btn btn-white btn-xs" href="{$_value['edit']}">{$catalog['objects']['button']['edit']['head']}</a>
														  <a class="btn btn-warning btn-xs" href="{$_value['delete']}">{$catalog['objects']['button']['delete']['head']}</a>
-->
														</td>
													</tr>
													{end}
													<!--
														<tr class="gradeC">
															<td>Trident</td>
															<td>Internet
																Explorer 5.0
															</td>
														</tr>
														<tr class="gradeA">
															<td>Trident</td>
															<td>Internet
																Explorer 5.5
															</td>
														</tr>
													-->
												</tbody>
												<!--
													<tfoot>
													<tr>
														<th>Rendering engine</th>
														<th>Browser</th>
													</tr>
													</tfoot>
													-->
											</table>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div id="modal-form" class="modal fade" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<div class="modal-body">
									<div class="row">
										<div class="col-sm-12"><h3 class="m-t-none m-b">Переименовать</h3>

											<p>Введите новое имя для <b>admin</b></p>

											<form id="form-rename" role="form" method="POST">
												<div class="form-group">
													<input type="text" name="new_name" placeholder="Введите новое имя" class="form-control js-form-new-name" required>
													<input type="hidden" name="collection" class="form-control">
													<input type="hidden" name="object" class="form-control">
												</div>
												<div>
													<button class="btn btn-sm btn-primary pull-right" type="submit">Сохранить</button>
													<button class="btn btn-sm btn-white pull-right btn-close-modal">Закрыть</button>
												</div>
											</form>
										</div>
										
									</div>
								</div>
							</div>
						</div>
					</div>
				
				</div>
				<!-- Footer block -->
				{require "../../~section/footer.html"}
				<!-- End Footer block -->
			</div>
		</div>
		<!-- Mainly scripts -->
		<script src="../../js/jquery-2.1.1.js"></script>
		<script src="../../js/bootstrap.min.js"></script>
		<script src="../../js/plugins/metisMenu/jquery.metisMenu.js"></script>
		<script src="../../js/plugins/slimscroll/jquery.slimscroll.min.js"></script>
		<!-- Toastr script -->
		<script src="../../js/plugins/toastr/toastr.min.js"></script>
		<!-- Custom and plugin javascript -->
		<script src="../../js/inspinia.js"></script>
		<script src="../../js/plugins/pace/pace.min.js"></script>
		<script>
			$(document).ready(function()
		  	{
				$('.file-box').each(function() {
					animationHover(this, 'pulse');
				});

				$('.btn-delete-collection').click(function() {
					var dlink = $(this).data('link');
					var head  = $(this).data('head');

					if (confirm(`Удалить коллекцию "${head}" со всем содержимым?`))
					{
						alert(dlink);
					}
				});

				$('.new-collection-btn').click(function(e) {
					e.preventDefault()
					if(!$('.new-collection-name').val()) {
						toastr.warning("Введите имя новой коллекции");
						return;
					}
					$('#new-collection-form').submit();
				});

				$('.btn-close-modal').click(function(e) {
					e.preventDefault()
					$('#modal-form').modal('hide');
				});

				$('.js-form-new-name').on('input paste keydown', function(e) { 
					filterInput(e);
				});

				const urlParams = new URLSearchParams(window.location.search);
				const collection = urlParams.get('collection');
				
				if (collection && collection.trim() !== '') {
					$('.edit-object').removeAttr('disabled');
					
					$('.edit-object').click(function() {
						window.location.href = $('.edit-object').data('link');
					});
				}
		  	});

		  	function showRenameModal (collection, rename_link, object) {
				$form = $('#modal-form');
				$form.modal('show');
				$form.find('b').text(object || collection);
				$form.find("[name='collection']").val(collection);
				$form.find("[name='new_name']").val('');
				$form.find("[name='object']").prop('disabled', !object).val(object || '');
				$('#form-rename').attr('action', rename_link);
		  	}

			function importObjects()
			{
				var input = document.createElement('input');
				input.type = 'file';
				input.name = 'objects';

				input.onchange = e =>
				{

					// getting a hold of the file reference
					var file = e.target.files[0];

					// setting up the reader
					var reader = new FileReader();
					reader.readAsDataURL(file); // this is reading as data url

					//~ reader.onload = function ()
					//~ {
						//~ strEncoded = reader.result;
						//~ console.log( window.atob( strEncoded ));
					//~ };


					//~ // here we tell the reader what to do when it done reading...
					reader.onload = readerEvent =>
					{
						var content = readerEvent.target.result; // this is the content!
						content = atob(content.substring(29));
						toastr.info("Импортирую...");

						$.ajax({
							url: "admin/constructor/object/import",
							method: "POST",
							data: { jsonData: content }
						}).done(function(data)
						{
							if (data == "OK")
							{
								toastr.success(data);
								location.reload(); // window.location.reload()
							}
							else
							{
								toastr.warning(data);
							}
							console.log(data);
						});
					}

				}

				input.click();
			}

			function filterInput(e) {
				const input = e.target;
				
				switch (e.type) {
					case 'paste':
						e.preventDefault();
						const cleanData = (e.originalEvent || e).clipboardData
							.getData('text')
							.replace(/[.= \r]/g, '');
						document.execCommand('insertText', false, cleanData);
						break;

					case 'keydown':
						if (['.', '=', ' ', 'Enter'].includes(e.key)) {
							e.preventDefault();
							return false;
						}
						break;

					case 'input':
						const cursorPos = input.selectionStart;
						const cleanValue = input.value.replace(/[.= \r]/g, '');
						if (input.value !== cleanValue) {
							input.value = cleanValue;
							input.setSelectionRange(cursorPos, cursorPos);
						}
						break;
				}
			}
		</script>
	</body>
</html>
